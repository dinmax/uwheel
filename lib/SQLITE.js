/*! uw - v0.0.12 - 2015-08-05 */module.exports=new function(){var a,b=uw.config,c=require("q"),d=require("sqlite3").verbose(),e="sqlite 	",f=require("./log.js"),g=this;this.connect=function(){function g(a){a?f.error("UW ",e,"connect ",a):h.resolve()}var h=c.defer();return a=new d.Database(b.database.dbname,g),h.promise},this.getAll=function(b,d){function h(d){var e=c.defer();return a.all(b,function(a,b){a?e.reject(a):e.resolve(b)}),e.promise}function i(a){f.error(e,a)}return g.connect().then(h)["catch"](i)},this.run=function(b,d){function h(e){var f=c.defer();return a.run(b,d,function(a){a?f.reject(a):f.resolve({lastID:this.lastID,changes:this.changes})}),f.promise}function i(a){f.error(e,a)}return g.connect().then(h)["catch"](i)},this.query=function(a,b){var c=/(select)/gi,d=/(pragma)/gi;return c.test(a)||d.test(a)?g.getAll(a,b):g.run(a,b)},this.getTables=function(){function b(a){a.pk=a.pk?!0:!1}function d(b){var d="SELECT name FROM sqlite_master WHERE type='table'",e=c.defer();return a.all(d,function(a,b){a||e.resolve(b)}),e.promise}function e(d){function e(c){var e="PRAGMA TABLE_INFO('"+c.name+"')";a.all(e,function(a,e){if(!a){f[c.name]={name:c.name,fields:{}};for(var i=f[c.name].fields,j=0,k=e[j];k;k=e[j++])i[k.name]=k,b(k);h++==d.length&&g.resolve(f)}})}var g=c.defer(),h=0;return a.serialize(function(){for(var a=0,b=d[0];b;b=d[a++])e(b)}),g.promise}var f={};return g.connect().then(d).then(e)}};